// Generated by CoffeeScript 1.10.0
'use strict';

/**
 * @ngdoc function
 * @name sgaAdminApp.controller:LoginCtrl
 * @description
 * # LoginCtrl
 * Controller of the sgaAdminApp
 */
angular.module('sgaAdminApp').controller('LoginCtrl', [
	'$rootScope', '$scope', '$location', 'permissionService', 'config', 'Auth', 'User', 'UsersApi',
	function($rootScope, $scope, $location, permissionService, config, Auth, User, UsersApi) {
		$scope.loginFail = false;
		$scope.user = {
			Name: '',
			Password: '',
			SourceToken: 'SUGAR'
		};
		$scope.permissionService = permissionService;

		return $scope.login = function() {
			return User.login($scope.user).then(function(res) {
				var ref, returnPath;
				if (res.status === 200 && res.data != null) {

					var claims = [];
					var id = res.data['response']['user'].id;

					UsersApi['actorClaim'].list(id).then(function (res){
						if (res.status === 200 && res.data != null)
						{
							claims = res.data['response'];
							$scope.permissionService.setClaims(id, claims);
						}
					})
					
					$rootScope.$broadcast('updateNavbar');
					
					returnPath = $location.search()["return"];
					if (returnPath != null) {
						$location.search('return', null);
						return $location.path(returnPath);
					} else {
						return $location.path('/');
					}
				}
			}).catch(function(res) {
				if (res.status === -1) {
					$scope.loginFail = true;
					var name = false;
				}

			});;
		};
	}
]);
