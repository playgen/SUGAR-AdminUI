// Generated by CoffeeScript 1.10.0
'use strict';

/**
 * @ngdoc function
 * @name sgaAdminApp.controller:LoginCtrl
 * @description
 * # LoginCtrl
 * Controller of the sgaAdminApp
 */
angular.module('sgaAdminApp').controller('LoginCtrl', [
	'$scope', '$location', 'permissionServices', 'config', 'Auth', 'User', 'UsersApi',
	function($scope, $location, permissionServices, config, Auth, User, UsersApi) {
		$scope.loginFail = false;
		$scope.user = {
			Name: '',
			Password: '',
			SourceToken: 'SUGAR'
		};
		$scope.permissionServices = permissionServices;
/*		$scope.register = function() {
			User.register($scope.user).then(function(res) {
					//automatically log in
					if (res.status === 200)
						$scope.submit();
					// $scope.user.Name = '';
					// $scope.user.Password = '';
				})
				.catch(function(res) {
					if (res.status === -1) {
						$scope.loginFail = false;
						$scope.registerFail = true;

						var name = false;
					}

				});
		}*/
		return $scope.login = function() {
			return User.login($scope.user).then(function(res) {
				var ref, returnPath;
				if (res.status === 200 && res.data != null) {

					var claims = [];
					var id = res.data['response']['user'].id;

					UsersApi['actorClaim'].list(id).then(function (res){
						if (res.status === 200 && res.data != null)
						{
							claims = res.data['response'];
							$scope.permissionServices.setClaims(id, claims);
						}
					})
					

					returnPath = $location.search()["return"];
					if (returnPath != null) {
						$location.search('return', null);
						return $location.path(returnPath);
					} else {
						return $location.path('/');
					}
				}
			}).catch(function(res) {
				if (res.status === -1) {
					$scope.loginFail = true;
					var name = false;
				}

			});;
		};
	}
]);
